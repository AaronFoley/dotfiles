define("discovery/models",["underscore","backbone","moment","core/analytics/identity","core/time","core/utils/url/serialize"],function(a,b,c,d,e,f){"use strict";var g=function(a){var b=a.prototype;return a.extend({defaults:{redirectUrl:null,signedUrl:null,userId:null,sourceThreadId:null,forumId:null,forum:null,majorVersion:null,requestBin:null},redirectPayload:function(){var a={url:this.get("signedUrl"),imp:d.impression.impId,prev_imp:d.impression.prevImp,forum_id:this.get("forumId"),forum:this.get("forum"),thread_id:this.get("sourceThreadId")};return this.has("requestBin")&&(a.bin=this.get("requestBin")),this.has("userId")&&(a.user_id=this.get("userId")),a},redirectUrl:function(){var a=this.get("redirectUrl"),b=this.redirectPayload();return f(a,b)},toJSON:function(){var a=b.toJSON.call(this);return a.redirectUrl=this.redirectUrl(),a},toString:function(){return this.get("title")+" "+this.get("link")+" (id = "+this.id+")"}})}(b.Model),h=function(b){var d=b.prototype;return b.extend({defaults:a.defaults({createdAgo:!1},d.defaults),initialize:function(a,b){if(b&&b.humanFriendlyTimestamp){var d=e.assureTzOffset(this.get("createdAt"));d=c(d,e.ISO_8601),this.set("createdAgo",d.fromNow())}},redirectPayload:function(){var b=d.redirectPayload.call(this);return a.extend(b,{thread:this.id,zone:"thread",area:this.state?this.state.get("placement"):"",object_type:"thread",object_id:this.id}),b},toJSON:function(){var a=d.toJSON.call(this);return a.thumbnailUrl=a.thumbnail,a.preview&&(a.preview=a.preview.toJSON()),a},toString:function(){return"organic link: "+d.toString.call(this)}})}(g),i=function(b){var c=b.prototype;return b.extend({idAttribute:"advertisement_id",defaults:a.defaults({brand:null,headline:null,text:null,url:null,signedUrl:null,advertisement_id:null,tracking_pixels_onview:null},c.defaults),parse:function(a){return a.signedUrl=a.signed_url,a.thumbnailUrl=a.thumbnail_url,delete a.signed_url,a},get:function(a){return{title:this.attributes.headline,link:this.attributes.url}[a]||c.get.call(this,a)},redirectPayload:function(){var b=c.redirectPayload.call(this);return a.extend(b,{zone:"thread",area:this.state?this.state.get("placement"):"",advertisement_id:this.get("advertisement_id"),brand:this.get("brand"),headline:this.get("headline"),ad_product_name:"sponsored_links",ad_product_layout:this.get("layout")}),b},toJSON:function(){var a=c.toJSON.call(this);return a.title=a.headline,a.link=a.url,a},toString:function(){return"promoted link: "+c.toString.call(this)}})}(g),j={RelatedThread:h,Advertisement:i};return DISQUS.testing&&(j.BaseContentModel=g),j}),define("discovery/exceptions",[],function(){"use strict";var a=function(a,b){var c=function(){var c=Error.apply(this,arguments);return c.name=this.name=a,this.disqusCode=b||"uncaught",this.message=c.message,this.stack=c.stack,this},d=function(){};return d.prototype=Error.prototype,c.prototype=new d,c};return{NoAds:a("NoAds","no_ads"),NoBinError:a("NoBinError","no_bin"),AdsExhaustedError:a("AdsExhaustedError","ads_exhausted"),RenderError:a("RenderError","render_error"),FetchError:a("FetchError","fetch_error"),TimeoutError:a("TimeoutError","timeout"),ValidationError:a("ValidationError","validation_error"),AdBlockError:a("AdBlockError","ad_block")}}),define("discovery/custom-comments",["jquery","underscore","when","core/utils","shared/urls","discovery/exceptions","exports"],function(a,b,c,d,e,f,g){"use strict";g.getProtocol=function(a){var b=(a||"").match(/^\s*(\w+:)?\/\//);return b?(b[1]||"").toLowerCase():null},g.getPageProtocol=function(){return window.location.protocol},g.forceWebProtocol=function(a,b){var c=g.getProtocol(a);if(null===c)return"";var d=g.getPageProtocol();return c||(c=d),"http:"===d&&(b=!0),"http:"===c&&b||(c="https:"),e.ensureHttpBasedProtocol(a,c)};var h=/<(\S+)[^<]+$/;g.extractTrackingTags=function(a){if(b.isArray(a))return b.map(a,function(a){return{tag:"img",url:a}});for(var c=d.bleachFindUrls(a),e=[],f=0;f<c.length;++f){var i=c[f],j=i.index,k=0;f>0&&(k=c[f-1].endIndex);var l=a.substr(k,j-k),m=h.exec(l);if(m){var n=m[1].toLowerCase();if("img"===n||"iframe"===n){var o=g.forceWebProtocol(i.url);o&&e.push({tag:n,url:o})}}}return e},g.ajax=function(b){var d=c.defer(),e=d.promise;return a.ajax(b).done(function(){d.resolve.apply(d,arguments)}).fail(function(a,b,c){d.reject(new f.FetchError(c))}),e},g.handlers={};var i=function(a){var b=(a.main_media&&a.main_media[0]||{}).url,c=(a.custom||{}).brand_name,d=g.forceWebProtocol(decodeURIComponent(a.click_url));return{title:a.title,summary:a.description,target_url:d,brand_name:c,thumbnail_url:g.forceWebProtocol(b),layout:"image_target",tracking_pixels_onload:g.extractTrackingTags(a.impression_trackers),tracking_pixels_onclick:g.extractTrackingTags(a.click_trackers)}},j=function(a){var b=(a.main_media&&a.main_media[0]||{}).url;return{media_url:g.forceWebProtocol(b),target_url:g.forceWebProtocol(a.click_url,!0),brand_name:(a.custom||{}).brand_name||a.title,brand_image_url:g.forceWebProtocol(a.icon_img_url),summary:a.description,layout:"iframe",tracking_pixels_onload:g.extractTrackingTags(a.impression_trackers),tracking_pixels_onclick:g.extractTrackingTags(a.click_trackers)}};g.handlers.appnexus=function(a,b){if(!a.get("placement_id"))throw new f.ValidationError("No placement_id specified.");return g.ajax({url:"https://mobile.adnxs.com/mob",data:{id:a.get("placement_id"),size:"1x1",st:"web",version:1,referrer:b},xhrFields:{withCredentials:!0}}).then(function(b){if(!b)throw new f.NoAds("Provider response had no data.");var c=(b["native"]||b.ads||[null])[0];if(!c)throw new f.NoAds("Neither 'native' nor 'ads' fields were found in response.");var d=!1;try{d=JSON.parse(c.custom.object).is_video}catch(e){}return d?a.set(j(c)):a.set(i(c)),a})},g.handlers.criteo_dr=function(a){return g.ajax({url:"https://cas.criteo.com/delivery/0.1/napi.jsonp",data:{zoneid:a.get("zoneid")||269381},dataType:"jsonp",timeout:1e4}).then(function(c){if(0!==c.response_status)throw new f.NoAds(c.status_message||"No offer from Criteo.");var d=c.advertiser,e=c.products&&c.products[0];if(!e||!d)throw new f.NoAds("No ad found.");return b.each(c.impression_pixels,function(a){a.tag="img"}),a.set({title:e.title,summary:e.description,target_url:e.click_url,brand_name:d.description,layout:"image_target",tracking_pixels_onload:c.impression_pixels,privacy_click_url:c.privacy.optout_click_url,thumbnail_url:g.forceWebProtocol(e.image.url),privacy_image_url:g.forceWebProtocol(c.privacy.optout_image_url)}),a})},g.handlers.appnexus_dr=function(a,b){if(!a.get("placement_id"))throw new f.ValidationError("No placement_id specified.");return g.ajax({url:"https://ib.adnxs.com/mob",data:{id:a.get("placement_id"),st:"web",referrer:b,format:"json",psa:0}}).then(function(b){if(!(b&&b.ads&&b.ads.length))throw new f.NoAds("No data in response found.");var c=b.ads[0];if(!(c.content&&c.width&&c.height))throw new f.ValidationError("Ad is missing some of the required fields.");return a.set({content:c.content,width:c.width,height:c.height}),a})}}),define("discovery/helpers",["underscore","jquery","loglevel","raven","remote/config"],function(a,b,c,d,e){"use strict";var f=function(b,c){var d=e.discovery||{},f=b.discoveryVariant,g=d.variantSpecific||{};if(f)f=a.extend(a.omit(d,"variantSpecific"),{name:f,thumbnailsEnabled:b.discoveryThumbnailsEnabled},g[f]);else{if(!b.adsVideoEnabled&&!b.adsDRNativeEnabled)return;f={organicEnabled:!1,promotedEnabled:!1}}return c.disable_promoted&&!b.discoveryLocked&&(f.promotedEnabled=!1,f.thumbnailsEnabled=!1),f},g=function(d,e){function f(){return j.scrollHeight-j.offsetHeight>.2*k}function g(){i.lastChild&&!a.contains(["...","…"],i.lastChild.nodeValue)&&(l=i.appendChild(window.document.createTextNode(" "+o)),f()&&(i.removeChild(l),i.removeChild(i.lastChild),g()))}if(!d.closest("body").length)return void c.info("lineTruncate called on el not on DOM");if(d.text().length<1)return void c.info("lineTruncated called on empty el");var h=function(a){return 3!==a.nodeType};if(a.any(d.children(),h))return void c.info("lineTruncate called on non-flat el");var i=d[0],j=i;if("block"!==d.css("display"))for(;j.parentNode&&(j=j.parentNode,"block"!==b(j).css("display")););var k=parseFloat(d.css("font-size"),10);if(f()){e=e||{};var l,m,n=e.lines||1,o=e.ellipsis,p=d.text();if(p.length){var q=d.width()/k,r=parseInt(q*n,10),s=p.split(/\s/),t=0;d.empty();var u=s.length;for(m=0;u>m&&(t+=s[m].length+1,!(t>=r));m++)i.appendChild(document.createTextNode(" "+s[m]));if(f())for(;i.lastChild&&f();)l=i.removeChild(i.lastChild);else{do l=i.appendChild(document.createTextNode(" "+s[m++]));while(!f()&&u>m);i.removeChild(l)}o&&(a.isString(o)||(o="…"),g())}}},h=function(b){function c(a,b){return a+b}var d,e,f,g,h,i=a.keys(b),j=Math.floor(a.reduce(b,c,0)/2),k=i.length+1,l=j+1,m=new Array(k);for(d=0;k>d;d++)m[d]=new Array(l),m[d][0]={};for(e=1;l>e;e++)m[0][e]=!1;var n={};for(e=1;l>e;e++)for(d=1;k>d;d++)f=i[d-1],g=b[f],h=a.clone(m[d-1][e]),!h&&e>=g&&(h=a.clone(m[d-1][e-g]),h&&(h[f]=g,n=h)),m[d][e]=h;return[n,a.omit(b,a.keys(n))]},i=["product","zone","service","experiment","variant"],j=function(b){b=b||"";var c=a.object(i,b.split(":"));return{bin:b,experiment:c.experiment||"",variant:c.variant||""}},k=function(b,e){b&&(e&&e.state.set("error",b),c.debug(b),b.disqusCode?e&&e.reportError(b):b instanceof Error?d.captureException(b):b.readyState&&d.captureException(new Error(b.status+" "+b.statusText),{extra:a.compact(a.defaults({requestPath:b.getResponseHeader("url")},b.responseJSON))}))},l=function(){var a=window.navigator,b=!1;try{b=Boolean(new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(c){b=a.mimeTypes&&"object"==typeof a.mimeTypes["application/x-shockwave-flash"]||a.plugins&&"object"==typeof a.plugins["Shockwave Flash"]}return b},m=function(a,b){return"json"===b.dataType&&0===a.readyState&&0===a.status?(c.debug("Looks like client has blocked ads"),!0):void 0};return{generateVariantConfig:f,lineTruncate:g,balancedPartition:h,binToEventParams:j,reportError:k,hasFlash:l,requestWasAdBlocked:m}}),define("discovery/models/State",["backbone"],function(a){"use strict";var b={UNTOUCHED:1,PROCESSING:2,DONE:4};return a.Model.extend({defaults:{status:b.UNTOUCHED,placement:null,error:null},isResolved:function(){return this.isDone()&&!this.get("error")},isRejected:function(){return this.isDone()&&this.get("error")},isDone:function(){return this.get("status")===b.DONE}},{STATUS:b})}),define("discovery/models/BaseAd",["underscore","backbone","when","loglevel","discovery/custom-comments","discovery/helpers","discovery/models/State","core/analytics/jester","common/utils"],function(a,b,c,d,e,f,g,h,i){"use strict";var j={iframe:"video",image_target:"native_dr",video_vast:"video",video_iframe:"video"};return b.Model.extend({defaults:{timeout:1e4},idAttribute:"advertisement_id",initialize:function(){this.state=new g,"gravity"===this.getProvider()&&this.unset("timeout")},getProvider:function(){return this.get("provider")||this.get("ad_provider")},toLogString:function(){return"["+this.getProvider()+":"+this.get("layout")+"]"},fetch:function(b){this.state.set("status",g.STATUS.PROCESSING),b=b||{};var d=this.getProvider(),f=e.handlers[d];if(a.isFunction(f)){var h=f(this,b.sourceThreadUrl);return this.reportRequest(),h}return c.resolve(this)},reportRequest:function(){this.state.get("calledProvider")||(this.state.set("calledProvider",!0),this._report({verb:"call",object_type:"provider",object_id:this.getProvider(),adjective:1}))},reportLoad:function(){d.debug(this.toLogString()+": Unit is ready."),this._fireLoadPixels(),this._report({verb:"load"})},reportError:function(a){this._report({verb:"fail",object_type:"provider",object_id:this.getProvider(),adverb:a.disqusCode})},reportIABView:function(){this._fireViewPixels(),this._report({verb:"view",adverb:"iab-scroll"})},reportView:function(){this._report({verb:"view",adverb:"0ms-no50perc"})},reportPlayStart:function(){d.debug(this.toLogString()+": Video player reported play started."),this._report({verb:"start-playing"})},reportPlayEnd:function(){d.debug(this.toLogString()+": Video player reported play ended."),this._report({verb:"finish-playing"})},reportClick:function(){this._report({verb:"click"})},_report:function(b){var c=this.get("layout");return h.client.emit(a.defaults(b,{object_type:"advertisement",object_id:"["+this.id+"]",advertisement_id:this.id,ad_product_name:j[c]||c,ad_product_layout:c,zone:"thread",area:this.state.get("placement")},f.binToEventParams(this.get("bin"))))},fireClickPixels:function(){var a=this.get("tracking_pixels_onclick");i.loadPixels(a)},reportCriteoDemand:function(a){this._report({verb:a?"accept":"reject",object_id:"criteo",object_type:"cookie",product:"tempest",zone:"adrouter",advertisement_id:"189322",ad_product_name:"native_dr"})},_fireViewPixels:function(){var a=this.get("tracking_pixels_onview")||[],b=this.get("tracking_pixel_url");b&&a.push({tag:"img",url:b}),i.loadPixels(a)},_fireLoadPixels:function(){var a=this.get("tracking_pixels_onload")||[];i.loadPixels(a)}})}),define("discovery/models/SponsoredLinkAd",["underscore","core/analytics/jester","discovery/helpers","discovery/models/BaseAd","discovery/exceptions"],function(a,b,c,d,e){"use strict";return d.extend({idAttribute:"layout",defaults:{provider:"Disqus"},initialize:function(b,c){var e=this;e.sponsoredLinks=c.sponsoredLinks,e.threads=c.threads,e.collections=[],e.app=c.app,a.bindAll(e,"validateCollectionMin","prepareData"),e.set("sectionNames",["col-organic","col-promoted"]),e.set("sectionIds",a.map(e.get("sectionNames"),function(a){return a+"-"+e.cid})),e.sequenceDataCollections(),d.prototype.initialize.apply(this,arguments),e.sponsoredLinks&&e.sponsoredLinks.each(function(a){a.state=e.state}),e.threads&&e.threads.each(function(a){a.state=e.state})},sequenceDataCollections:function(){var b=this.app;this.collections.push(this.threads),"headlines_2x4"===this.get("layout")&&this.collections.pop(),b.get("promotedEnabled")&&this.collections.push(this.sponsoredLinks),this.collections=a.compact(this.collections);var c=b.get("promotedEnabled")&&1===this.collections.length,d=b.get("promotedEnabled")&&"left"===b.get("promotedSide");(d||c)&&(this.get("sectionNames")&&this.get("sectionNames").reverse(),this.get("sectionIds")&&this.get("sectionIds").reverse(),this.collections.reverse())},hasData:function(){return a.some(this.collections,function(a){return a.length})},validateCollectionMin:function(){for(var b,c,d=this.collections,e=this.get("sectionNames").slice(0),f=this.get("sectionIds").slice(0),g=d.length;g>0;)b=d[--g],c=b.minLength,b.length<c&&(d.splice(g,1),e.splice(g,1),f.splice(g,1),g=d.length);if(a.isNumber(this.app.get("numColumns"))&&a.isNumber(this.app.get("minPerColumn"))){var h=this.app.get("numColumns")*this.app.get("minPerColumn"),i=a.reduce(d,function(a,b){return a+b.length},0);h>i&&(d.splice(0,d.length),e.splice(0,e.length),f.splice(0,f.length))}this.set("sectionNames",e),this.set("sectionIds",f)},prepareData:function(){var b=this.commonClickMetadata();this.sponsoredLinks.addClickMetadata(a.defaults({layout:this.getLayout()},b)),this.threads.addClickMetadata(b)},trimOrganic:function(){var a=this.threads;a.length>a.maxLength&&a.reset(a.slice(0,a.maxLength))},validateData:function(){var a=this;if(a.threads.maxLength=a.app.getCollectionMax("Organic"),1===a.collections.length&&a.deactivateThumbnails(),this.sponsoredLinks.validate(),this.validateCollectionMin(),this.prepareData(),!a.hasData())throw new e.ValidationError("Not enough data")},deactivateThumbnails:function(){this.app.set({contentPreviews:!0})},commonClickMetadata:function(){var a=this.app,b=a.get("sourceForum"),c={redirectUrl:a.get("redirectUrl"),sourceThreadId:a.get("sourceThread").id,forumId:b.pk,forum:b.id,requestBin:a.get("requestBin")};return a.session.isKnownToBeLoggedOut()||(c.userId=a.session.fromCookie().id),c},report:function(c){a.isEmpty(c)||b.client.emit(a.extend(this.snapshot(),c))},snapshot:function(){var b=this.threads,d=this.app,e=c.binToEventParams(d.get("requestBin")),f=d.session,g=f&&!f.isKnownToBeLoggedOut()?{userId:f.fromCookie().id}:{},h=a.extend({internal_organic:b&&b.length,external_organic:0,promoted:0,display:!0,placement:this.state.get("placement"),zone:"thread",area:this.state.get("placement"),thread_id:d.get("sourceThread").id,forum_id:d.get("sourceForum").pk},g,e,this.getAdData());return h},getAdData:function(){var a=this.app;if(!a.get("promotedEnabled"))return{object_type:"link"};var b=JSON.stringify(this.sponsoredLinks.pluck("advertisement_id"));return{promoted:this.sponsoredLinks.length,promoted_ids:b,object_type:"advertisement",object_id:b,advertisement_id:b,ad_product_name:"sponsored_links",ad_product_layout:this.getLayout()}},getLayout:function(){var a=this.get("layout");return"links"===a&&(a=this.areThumbnailsEnabled()?"thumbnails":"headlines"),a},areThumbnailsEnabled:function(){return this.app.get("maxPromotedThumbnailLinks")}})}),define("discovery/collections",["backbone","underscore","when","loglevel","core/api","core/utils","core/utils/html","common/urls","discovery/models","discovery/models/BaseAd","discovery/models/SponsoredLinkAd"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l=a.Collection.extend({url:function(a){return e.getURL(a)}}),m=function(a){var b=a.prototype;return a.extend({url:function(){return b.url.call(this,"discovery/listTopPost.json")},parse:function(a){for(var c=b.parse.call(this,a),d=0,e=c.length;e>d;d++)c[d].plaintext=g.stripTags(c[d].message);return c}})}(l),n=l.extend({initialize:function(a,b){this.model=i[this.modelName],this.name=b.name,this.minLength=b.minLength,this.maxLength=b.maxLength},addClickMetadata:function(a){this.invoke("set",a)}}),o=n.extend({modelName:"RelatedThread",initialize:function(a,b){n.prototype.initialize.call(this,a,b),this.previews=new m},url:function(){return n.prototype.url.call(this,"discovery/listRelated.json")},fetch:function(a,b){a.data.limit=2*this.maxLength;var e=c(n.prototype.fetch.call(this,a)),f=this;return b&&(e=e.then(function(){return f.getContentPreviews().otherwise(function(a){d.info("There was a problem getting snippets: ",a)})})),e},getContentPreviews:function(){var a=this.map(function(a){return parseInt(a.get("id"),10)});if(a.length<this.minLength)return c.resolve();a.sort(function(a,b){return a-b});var d=c(this.previews.fetch({data:{thread:a},timeout:o.CONTENT_PREVIEWS_FETCH_TIMEOUT}));return d.then(b.bind(this.attachPreviews,this))},attachPreviews:function(){this.previews.each(function(a){var b=a.get("thread"),c=this.get(b);c&&c.set("preview",a)},this)}},{CONTENT_PREVIEWS_FETCH_TIMEOUT:5e3}),p=n.extend({modelName:"Advertisement",initialize:function(a,c){c=b.extend({name:"Promoted",minLength:1},c),n.prototype.initialize.call(this,a,c)},parse:function(a){return a},validate:function(){f.isMobileUserAgent()&&this.length>0&&this.remove(this.where({mobile:!1}))}}),q=l.extend({url:h.tempest+"/listPromoted",initialize:function(b,c){c=c||{},this._top=new a.Collection,this._bottom=new a.Collection},fetch:function(a){return c(l.prototype.fetch.call(this,a))},getTopAds:function(){return this._top},getBottomAds:function(){return this._bottom},parse:function(a,c){function d(a){switch(a.bin=e,a.layout){case"headlines_2x4":case"thumbnails_3x2":case"links":var b="links"===a.layout?c.sponsoredLinksMaxLength:a.ads.length;return new k(a,{sponsoredLinks:new p(a.ads,{parse:!0,maxLength:b}),threads:c.threads,app:c.app});default:return new j(a)}}var e=a.bin;this._top.reset(b.map(a.top_placement||a.big_unit,d,this)),this._bottom.reset(b.map(a.bottom_placement,d,this))}}),r={PostCollection:m,RelatedThreadCollection:o,AdvertisementCollection:q,SponsoredLinksCollection:p};return window.DISQUS.testing&&(r.BaseCollection=l,r.BaseContentCollection=n),r}),define("discovery/variants",[],function(){"use strict";return{"default":{maxPerColumn:2,inlineMeta:!1,contentPreviews:!0,promotedEnabled:!1,topPlacementEnabled:!1},promoted:{maxPerColumn:4,inlineMeta:!0,contentPreviews:!1,promotedEnabled:!0,topPlacementEnabled:!1,promotedSide:"right"},max:{maxPerColumn:4,inlineMeta:!0,contentPreviews:!1,promotedEnabled:!0,topPlacementEnabled:!0,promotedSide:"left"},thumbnails:{maxPromotedThumbnailLinks:4,promotedSide:"left",numLinesHeadline:4}}}),define("discovery/views/Iframe",["jquery","loglevel","underscore","backbone","core/utils/urls"],function(a,b,c,d,e){"use strict";var f=d.View.extend({tagName:"iframe",initialize:function(b){var d=b.src||this.el.src;this._source=d,this._origin=e.getOrigin(d),this._onMessage=c.bind(this._onMessage,this),a(window).on("message",this._onMessage),this._ready=!1,this._buffer=[],this.once("message",this._onLoad)},_onLoad:function(){this._ready=!0,c.each(this._buffer,this.postMessage,this)},_onMessage:function(a){if(a=a.originalEvent,a&&a.origin===this._origin){var c=a.data;try{c=JSON.parse(c)}catch(d){b.debug("Received non-JSON message, letting it through",c)}this.trigger("message",c,this,a.data)}},render:function(){return this.$el.attr("src",this._source),this},postMessage:function(a){if(this._ready)try{a=c.isString(a)?a:JSON.stringify(a),this.el.contentWindow.postMessage(a,this._origin)}catch(b){}else this._buffer.push(a)},remove:function(){return a(window).off("message",this._onMessage),d.View.prototype.remove.apply(this,arguments)}});return f}),define("core/utils/OnceTimer",["require","exports","module"],function(a,b,c){"use strict";c.exports=function(a,b){var c=null,d=!1;this.start=function(){d||(c=window.setTimeout(function(){d=!0,a()},b))},this.clear=function(){window.clearTimeout(c)}}}),define("discovery/views/BaseUnit",["backbone","underscore","stance","stance/utils","when","core/utils/OnceTimer","discovery/exceptions"],function(a,b,c,d,e,f,g){"use strict";return a.View.extend({className:"generic-ad__wrapper",initialize:function(){this._isReady=e.defer(),this._isReady.promise.then(b.bind(this._onResolve,this))},isReady:function(){return this._isReady.promise},_onResolve:function(){this.listenTo(this,{"view:iab":b.bind(this.model.reportIABView,this.model)}),this._setupViewEvents(),this.model.reportLoad()},_rejectReadyPromise:function(a){this._isReady.reject(a)},handleReady:function(){this._isReady.resolve()},handleRenderError:function(a){this._rejectReadyPromise(new g.RenderError(a))},handleTimeoutError:function(a){this._rejectReadyPromise(new g.TimeoutError(a))},handleNoOfferError:function(a){this._rejectReadyPromise(new g.NoAds(a))},_setupViewEvents:function(){var a=this,e=!1,g=new f(b.bind(this.trigger,this,"view:iab"),1e3);a.on("view:50in",g.start,g),a.on("view:50out",g.clear,g),a.listenTo(c({el:a.el}),{enter:function(){a.trigger("view:enter",a)},exit:function(){a.trigger("view:exit",a),e&&(e=!1,a.trigger("view:50out",a))},visible:function(b,c){var f=d.visiblePercent(c,b.offset());f>=50&&!e?(e=!0,a.trigger("view:50in",a)):50>f&&e&&(e=!1,a.trigger("view:50out",a)),a.trigger("view",a,{percentViewable:f})}})}})}),define("discovery/views/HostUnit",["discovery/views/BaseUnit"],function(a){"use strict";return a.extend({injectable:function(){return this.model.get("content")},render:function(){return this.handleReady(),this}})}),define("discovery/views/IframeUnit",["jquery","underscore","core/bus","common/templates","discovery/views/BaseUnit","discovery/views/Iframe"],function(a,b,c,d,e,f){"use strict";var g=e.extend({proxyEvents:{"view:iab":1,"view:50in":1,"view:50out":1,"view:enter":1,"view:exit":1,view:1},templateName:"videoAd",initialize:function(){e.prototype.initialize.apply(this,arguments),this.readyTimeout=this.model.get("timeout"),this.listenTo(this,"all",this._proxyEvents),this.listenTo(c.frame,"embed.resized",b.debounce(b.bind(this.render,this),100))},isEmbedHidden:function(){return!a("body").width()},_proxyEvents:function(a,b,c){if(this.proxyEvents[a]){var d={event:a,space:"disqus"};c&&c.percentViewable&&(d.percentViewable=c.percentViewable),"view"!==a&&this._postMessage("disqus."+a),this._postMessage(d),"view:iab"===a&&this._postMessage("disqus.inView")}},startTimeout:function(a,c){this.cancelTimeout(),this._timeout=b.delay(b.bind(this.handleTimeoutError,this,c||"Unit timed out."),a)},cancelTimeout:function(){window.clearTimeout(this._timeout)},remove:function(){return this.readyTimeout&&this.cancelTimeout(),this._removeFrame(),e.prototype.remove.apply(this,arguments)},_removeFrame:function(){this.frame&&(this.stopListening(this.frame),this.frame.remove())},render:function(){if(this.isEmbedHidden())return this;this.stopListening(c.frame,"embed.resized"),this._removeFrame();var a=this.serializeData();return this.$el.html(d.render(this.templateName,a)),this.frame=new f({el:this.$("iframe")[0],src:a.iframeUrl}),this.listenTo(this.frame,"message",this.handleMessage),this.model.reportRequest(),this.frame.render(),this.readyTimeout&&this.startTimeout(this.readyTimeout,"Provider timed out."),this},_postMessage:function(a){this.frame.postMessage(a)},serializeData:function(){return this.model.toJSON()},handleMessage:function(){}});return g}),define("discovery/views/IABDisplayUnit",["loglevel","remote/config","discovery/views/IframeUnit"],function(a,b,c){"use strict";var d=/(%|px)$/,e=function(a){if("auto"===a)return a;var b=String(a).match(d);return a=parseFloat(a,10)||0,b?a+b[1]:a},f=c.extend({className:"iab-ad__wrapper",templateName:"iabAd",initialize:function(a){c.prototype.initialize.apply(this,arguments),this.noAutoReady=a.noAutoReady,this.uid=String(this.model.id),this.publisherSettings=a.publisherSettings},getIframeUrl:function(){var a=b.discovery.iabDisplayUrl||"";return"adsnative"===this.model.get("provider")&&(a+="#provider=adsnative"),a},serializeData:function(){var a=this.getIframeUrl();return{iframeUrl:a,iframeName:this.uid}},handleMessage:function(a,b,c){return a.version?this._handleGravityMessage(a,c):a.sender===this.uid?this._handleDisqusMessage(a):void 0},_handleDisqusMessage:function(a){switch(a.eventName){case"iframeLoaded":this.initAd();break;case"ready":this.cancelTimeout(),this.handleReady();break;case"resize":this.handleResize(a);break;case"noAd":case"no_ad":this.handleNoOfferError("No offer from the provider")}},_handleGravityMessage:function(b,c){a.debug("Gravity postMessage "+b.event+": "+c)},handleResize:function(a){var b=e(a.width),c=e(a.height);b&&this._currentWidth!==b&&(this._currentWidth=b,this.$("[data-role=iab-ad]").css("width",b)),c&&this._currentHeight!==c&&(this._currentHeight=c,this.frame.$el.css("height",c))},initAd:function(){var a=this.model.get("height");this.handleResize({width:this.model.get("width"),height:a});var b={method:"initAd",content:this.model.get("content"),autoResize:"auto"===a,noAutoReady:this.noAutoReady};"adsnative"===this.model.getProvider()&&(b.publisherSettings=this.publisherSettings),this._postMessage(b)}},{cleanStyleValues:e});return f}),define("discovery/views/ImageUnit",["discovery/views/BaseUnit","common/templates"],function(a,b){"use strict";var c=a.extend({className:"style-variant-default",events:{"click a":"handleLinkClick"},initialize:function(b){a.prototype.initialize.apply(this,arguments),this.redirectUrl=b.redirectUrl},handleLinkClick:function(a){this.model.fireClickPixels(),a.currentTarget&&-1===a.currentTarget.href.indexOf(this.redirectUrl)&&this.model.reportClick()},serializeData:function(){var a=this.model;return{title:a.get("title"),summary:a.get("summary"),targetUrl:a.get("target_url"),brandName:a.get("brand_name"),thumbnailUrl:a.get("thumbnail_url"),privacyClickUrl:a.get("privacy_click_url"),privacyImageUrl:a.get("privacy_image_url")}},render:function(){return this.$el.html(b.render("imageAd",this.serializeData())),this.handleReady(),this}});return c}),define("discovery/views/VastUnit",["jquery","underscore","stance","loglevel","remote/config","discovery/exceptions","discovery/views/IframeUnit"],function(a,b,c,d,e,f,g){"use strict";var h=2e3,i=1e4,j=g.extend({events:{"mouseenter [data-role=iframe-wrapper]":"turnSoundOn","mouseleave [data-role=iframe-wrapper]":"turnSoundOff"},templateName:"videoAd",supportedSizes:[{width:320,height:180},{width:480,height:352},{width:640,height:360}],initialize:function(){g.prototype.initialize.apply(this,arguments),this.listenTo(this,{"view:50in":this.startAd,"view:50out":this.pauseAd})},getIframeUrl:function(){return e.discovery.videoPlayerUrl||""},handleAlmostReady:function(){var a=c({el:this.el});this.listenToOnce(a,"enter",function(){this.model.reportView(),this.startAd()})},handleMessage:function(a){switch(a.eventName){case"iframeLoaded":this.initVideoPlayer();break;case"ready":this.cancelTimeout(),this.handleAlmostReady(),d.debug(this.model.toLogString()+': Got "ready" event from '+(a.isVast?"VAST":"VPAID")+" player.");break;case"play":this.cancelTimeout(),this.handleReady(),this.hasStarted=!0,this.model.reportPlayStart();break;case"error":this.handleRenderError("Cannot play video.");break;case"ended":this.hasStarted&&this.model.reportPlayEnd()}},_rejectReadyPromise:function(a){this.cancelTimeout();var b=this.model.toLogString();if(d.debug(b+": "+a),!this._rejectTimeout){var c=this;d.debug(b+": Waiting "+h+"ms before removing player from DOM."),c._rejectTimeout=window.setTimeout(function(){g.prototype._rejectReadyPromise.call(c,a)},h)}},getSize:function(){var a=Math.min(b.last(this.supportedSizes).width,this.getBodyWidth()),c=a/1.6;return{width:a,height:c}},serializeData:function(){var a=this.getIframeUrl(),c=this.getSize();if(!a)throw new f.ValidationError("Video player url is not specified");return{iframeUrl:b.template(a)({width:c.width,height:c.height}),height:c.height,width:c.width}},getBodyWidth:function(){return a("body").width()},initVideoPlayer:function(){var a=this.getSize();this._postMessage({method:"initPlayer",url:this.model.get("media_url"),width:a.width,height:a.height})},startAd:function(){d.debug(this.model.toLogString()+": Starting to play."),this.hasStarted||this.startTimeout(i,"Player took too long to play video."),this._postMessage({method:"playVideo"})},pauseAd:function(){this._postMessage({method:"pauseVideo"})},turnSoundOn:function(){this._postMessage({method:"turnSoundOn"})},turnSoundOff:function(){this._postMessage({method:"turnSoundOff"})}});return j}),define("discovery/views/VideoIframeUnit",["jquery","underscore","core/utils/urls","core/switches","discovery/views/IframeUnit"],function(a,b,c,d,e){"use strict";var f="ready",g="noOffer",h={ready:f,noOffer:g,"viroolWidget.playerReady":f,"viroolWidget.noOffers":g,"viroolWidget.offerConfigLoaded":f,vrl_not_found:g,ad_ready:f,ad_failed:g},i=e.extend({templateName:"videoAd",initialize:function(a){e.prototype.initialize.apply(this,arguments);var b=d.isFeatureActive("extended_ready_timeout",{domain:c.getHostName(a.sourceThreadUrl)});b&&(this.readyTimeout=2e4)},getIframeUrl:function(){return this.model.get("media_url")},serializeData:function(){var c,d=this.getIframeUrl(),e=this.model.get("width")||640;return e=Math.min(e,a("body").width()),c=e/1.6,{iframeUrl:b.template(d)({width:e,height:c}),height:c,width:"100%",title:this.model.get("title"),summary:this.model.get("summary"),targetUrl:this.model.get("target_url"),brandName:this.model.get("brand_name"),brandImageUrl:this.model.get("brand_image_url")}},handleMessage:function(a){try{a=JSON.parse(a).event}catch(b){}switch(h[a]){case f:this.cancelTimeout(),this.handleReady();break;case g:this.handleNoOfferError("No offer from the provider")}}});return i}),define("discovery/views/links/TwoColumn",["jquery","underscore","discovery/helpers"],function(a,b,c){"use strict";var d=function(b,c){this.modelIds=b||[],this.$elements=a(c||[])};b.extend(d.prototype,{height:function(){var c=this;c.heights=[];var d=a(c.$elements),e=d.first().offset().top,f=function(){var a=d.last();return a.offset().top+a.height()}(),g=f-e,h=0;return b.each(d,function(b){var d=a(b).height();c.heights.push(d),h+=d}),this.interstice=(g-h)/(d.length-1),g}});var e=function(){this.divideIntoColumns=function(){var a=this,b=a.subviews[0];a.left=new d,a.right=new d;var c=0;b.collection.each(function(d,e){var f=c++%2===0?"left":"right";a[f].modelIds.push(d.id),
Array.prototype.push.call(a[f].$elements,b.$elements[e])})},this.removeOneFromColumn=function(a,c){var d,e=b.chain(a.modelIds).map(function(b,c){return[b,a.heights[c]]}).sortBy(function(a){return-1*a[1]}).find(function(a){return a[1]<=c}).value()[0],f=this.subviews[0].collection,g=f.models,h=f.get(e),i=g.indexOf(h),j=[],k=[],l=[k,j],m=g.length;for(d=0;m>d;d++)l[d%2].push(g[d]);var n=l[i%2];n.splice(b.indexOf(n,h),1),g=[];var o=(i+1)%2;for(d=0;m-1>d;d++)g.push(l[(d+o)%2].shift());f.reset(g)},this.balanceColumns=function(){var a=this.subviews[0],d=a.collection,e={};d.each(function(b,c){e[c]=a.$elements.eq(c).height()});var f=c.balancedPartition(e);f=b.sortBy(f,"length");var g=f[1],h=f[0],i=d.models,j=new Array(i.length);b.each(g,function(a,b){j[2*b]=i[b]}),b.each(h,function(a,b){j[2*b+1]=i[b]}),d.reset(i)},this.shortenColumn=function(a,b){var c=this.subviews[0].collection;c.length%2!==0&&a===this.left?this.removeOneFromColumn(a,this.fudge*b):this.balanceColumns()}},f=function(){this.divideIntoColumns=function(){var a=this,b=a.subviews,c=b[0],e=b[1],f=c.collection.model.prototype.idAttribute;a.left=new d(c.collection.pluck(f),c.$elements);var g=e.collection.model.prototype.idAttribute;a.right=new d(e.collection.pluck(g),e.$elements)},this.shortenColumn=function(a,c){for(var d=a===this.left?this.subviews[0]:this.subviews[1],e=a===this.left?this.right:this.left,f=c/e.$elements.length,g=d.collection,h=b.chain(a.modelIds).map(function(b,c){return[b,a.heights[c]]}).sortBy(function(a){return a[1]}).value(),i=[],j=0,k=c,l=f;h.length;){var m=h.pop(),n=m[0],o=m[1],p=o+a.interstice;if(j+p>c&&(e=a),k=Math.abs(c-(j+p)),l=k/e.$elements.length,!(l>=f)){f=l;var q=a.modelIds.indexOf(n);a.modelIds.splice(q,1),Array.prototype.splice.call(a.$elements,q,1),j+=p,i.push(n)}}g.remove(i)}},g=function(a){this.fudge=a.fudge,this.subviews=a.views.slice(0,2),1===this.subviews.length?e.call(this):f.call(this)};return b.extend(g.prototype,{ascendingByHeight:function(){var a=this.left,c=this.right,d=[[a,a.height()],[c,c.height()]];return b.sortBy(d,function(a){return a[1]})},evenColumns:function(a){var c=this.ascendingByHeight(),d=c[0][0],e=c[0][1],f=c[1][0],g=c[1][1];if(e!==g){var h=g-e,i=this.fudge*h,j=b.find(f.heights,function(a){return a+f.interstice<i});return!a&&j?(this.shortenColumn(f,h),this.divideIntoColumns(),this.evenColumns("do not recurse again")):void this.increaseMargins(d,h)}},increaseMargins:function(c,d){var e=c.$elements.length;if(!(2>e)){var f=d/e;b.each(c.$elements,function(b){var c=a(b),d=parseInt(c.css("margin-bottom"),10),e=d+f;c.css("margin-bottom",e+"px")});var g=c===this.left?this.right:this.left,h=c===this.right?"left":"right";g.$elements.css("clear",h)}},render:function(){return this.divideIntoColumns(),this.evenColumns(),this}}),g}),define("discovery/views/links/BaseView",["backbone","when","common/templates"],function(a,b,c){"use strict";return a.View.extend({initialize:function(){this._isReady=b.defer()},isReady:function(){return this._isReady.promise},getTemplateContext:function(){return this.appContext||(this.appContext=this.model.app.toJSON()),{variant:this.appContext}},template:function(a,b){return b=b||this.templateName,c.render(b,a)},_rejectReadyPromise:function(a){this._isReady.reject(a)},handleReady:function(){this._isReady.resolve()}})}),define("discovery/views/links/BaseCollectionView",["underscore","jquery","stance","common/utils","discovery/helpers","discovery/views/links/BaseView"],function(a,b,c,d,e,f){"use strict";var g=f.extend({events:{"click [data-redirect]":"handleClick"},templateName:"discoveryCollection",handleClick:function(a){this.swapHref(a.currentTarget)},swapHref:function(b){b.setAttribute("data-href",b.getAttribute("href")),b.setAttribute("href",b.getAttribute("data-redirect")),a.delay(function(){b.setAttribute("href",b.getAttribute("data-href"))},100)},initialize:function(a){this.elementsSelector="li.discovery-post",this.$elements=this.$el.find(this.elementsSelector),this.initContext=a.context;var b=this.collection;this.listenTo(b,{remove:this.remove,reset:this.render}),this.visibilityTrackers={},this.queueViewEvents()},queueViewEvents:function(){if(this.model.app.get("promotedEnabled")){var d=function(){return b(this.el).height()/2};a.each(this.visibilityTrackers,function(a,b){a&&(this.collection.get(b)||(this.stopListening(a),this.visibilityTrackers[b]=null))},this),a.each(this.$elements,function(b){var e=b.getAttribute("data-id");if(!this.visibilityTrackers[e]){var f=this.collection.get(e);if(f){var g=c({el:b,timer:null,topEdgeOffset:d,bottomEdgeOffset:d});this.visibilityTrackers[e]=g;var h=a.bind(function(){this.reportIABView(e),this.stopListening(g)},this);this.listenTo(g,{enter:function(){g.timer=a.delay(h,1e3)},exit:function(){window.clearTimeout(g.timer)}})}}},this)}},reportIABView:function(a){var b=this.collection.get(a),c=b.get("tracking_pixels_onview")||[];d.loadPixels(c)},loadOnLoadPixels:function(){this.collection.each(function(a){var b=a.get("tracking_pixels_onload")||[];d.loadPixels(b)},this)},truncate:function(){var c=this.$el.find(".line-truncate");a.each(c,function(a){var c=b(a);e.lineTruncate(c,{lines:parseInt(c.attr("data-line-truncate"),10),ellipsis:!0})})},getTemplateContext:function(){var b=f.prototype.getTemplateContext.call(this);a.extend(b,this.initContext),b.collection=this.collection.toJSON();var c=this.collection.at(0);if(c){var d=c.has("id")?"organic-":"promoted-",e=c.idAttribute;a.each(b.collection,function(a){a.advertisement_id=a[e],a.domIdSuffix=a[e],a.domIdSuffix=d+a.domIdSuffix})}return b},render:function(){var a=this.getTemplateContext();return this.$el.html(this.template(a)),this.$elements=this.$el.find(this.elementsSelector),this.truncate(),this.loadOnLoadPixels(),this.queueViewEvents(),this},remove:function(c,d,e){if(0===arguments.length)return f.prototype.remove.call(this);var g=a.toArray(this.$elements),h=g.splice(e.index,1)[0];return b(h).remove(),this.$elements=b(g),this.queueViewEvents(),this}});return g}),define("discovery/views/links/MainView",["jquery","underscore","stance","discovery/views/links/TwoColumn","discovery/views/links/BaseView","discovery/views/links/BaseCollectionView"],function(a,b,c,d,e,f){"use strict";var g=440,h=e.extend({templateName:"discoveryMain",topEdgeOffset:0,bottomEdgeOffset:1/0,events:{"click [data-action=discovery-help]":function(a){a.preventDefault(),this.model.app.set("help",!0)},"click [data-action=discovery-help-close]":function(a){a.preventDefault(),this.model.app.set("help",!1)}},toggleHelp:function(){var a=this;a.$el.find("#discovery-note").toggle()},rerenderHelp:function(){var a=this.$el.find("#discovery-note");a.length&&a.html(this.template(this.getTemplateContext(),"discoveryNote"))},initialize:function(){e.prototype.initialize.apply(this,arguments);var a=this,c=this.model.app;this.listenTo(c,{"change:help":this.toggleHelp}),this.listenTo(c.session,"change",this.rerenderHelp),this.$el.css({display:"block",width:"100%"}),b.bindAll(this,"reportIfVisible"),this.isReady().then(function(){c.get("promotedEnabled")&&a.model.sponsoredLinks.length&&a.model.report({event:"activity.load_advertisement",verb:"load"})})},createSections:function(){var a=this.model,c=this.model.app,d=a.get("sectionNames"),e=a.get("sectionIds");return b.map(a.collections,function(b,f){var g;return b===a.threads?g="organic":b===a.sponsoredLinks&&(g="promoted"),{id:e[f],className:d[f],showThumbnailsInRows:"promoted"===g&&c.getThumbnailLinksMobile("Promoted"),collection:b,type:g}})},getTemplateContext:function(){var a=this.model.app,b=this.createSections();return{id:a.get("innerContainerId"),sections:b,forum:a.get("sourceForum"),thumbnailsEnabled:this.model.areThumbnailsEnabled()}},render:function(){var c=this;c.model.validateData(),c.model.app.get("trackAdVisibility")&&c.trackVisibility(),c.renderViews(),c.resizeHandler=b.debounce(function(){c.views&&b.invoke(c.views,"render")},100),a(window).on("resize",c.resizeHandler),c.handleReady()},renderViews:function(){var c=this.getTemplateContext(),d=this.model.app,e=this;this.$el.html(this.template(c));var g=!e.isTwoColumnLayout(),h=1===e.model.collections.length;(g||h)&&e.model.trimOrganic();var i=b.map(c.sections,function(b){var c=Boolean(d.get("max"+b.collection.name+"ThumbnailLinks"));return new f({model:e.model,collection:b.collection,el:a("#"+b.id+"> [data-role=discovery-posts]"),context:{thumbnailsEnabled:c}})});d.get("maxPromotedThumbnailLinks")?this.$el.find("#"+d.get("innerContainerId")).addClass("doublethumbnails"):2===i.length&&this.$el.find("#"+d.get("innerContainerId")).addClass("doublesection");var j=this.$el.width();this.$el.width(j-20),b.invoke(i,"render"),this.$el.width("100%"),this.views=i,this.evenColumns()},remove:function(){e.prototype.remove.call(this),this.resizeHandler&&a(window).off("resize",this.resizeHandler)},getWidth:function(){return this.$el.width()},isTwoColumnLayout:function(){return!this.model.areThumbnailsEnabled()&&this.getWidth()>=g},evenColumns:function(){if(this.isTwoColumnLayout()){var a=new d({views:this.views,fudge:1.2});a.render()}},reportIfVisible:function(){this.visibilityTracker&&this.visibilityTracker.isVisible()&&this.model.sponsoredLinks&&this.model.sponsoredLinks.length&&(this.stopListening(this.visibilityTracker),this.visibilityTracker=null,this.model.report({verb:"view"}))},trackVisibility:function(){var a=this.model.app;this.debouncedReportIfVisible=b.debounce(this.reportIfVisible,a.get("seenByUserThresholdTime")),this.visibilityTracker=c(this),this.listenTo(this.visibilityTracker,"enter",this.debouncedReportIfVisible)}});return h}),define("discovery/views/links/SponsoredLinks3x2Unit",["discovery/views/links/MainView"],function(a){"use strict";var b=a,c=b.prototype;return b.extend({render:function(){return c.render.call(this),this.$(".discovery-main").addClass("six-ads"),this}})}),define("discovery/views/Placement",["underscore","backbone","when","remote/config","discovery/exceptions","discovery/models/State","discovery/views/Iframe","discovery/views/HostUnit","discovery/views/IABDisplayUnit","discovery/views/ImageUnit","discovery/views/VastUnit","discovery/views/VideoIframeUnit","discovery/views/links/MainView","discovery/views/links/SponsoredLinks3x2Unit"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";var o=b.View.extend({className:"post-list",LAYOUT_TO_CLASS:{on_host:h,iab_display:i,silent_iab_display:function(b){return b=b?a.clone(b):{},b.noAutoReady=!0,new i(b)},iframe:l,image_target:j,video_iframe:l,video_vast:k,links:m,thumbnails_3x2:n,headlines_2x4:m},initialize:function(a){a=a||{},this.placement=a.placement,this.sourceThreadUrl=a.sourceThreadUrl,this.redirectUrl=a.redirectUrl,this.publisherSettings=a.publisherSettings,this._enabled=!0,this._collapse()},setRequestBin:function(a){this._bin=a},tryAd:function(b){this._unsetAd();var d=b.get("layout"),f=this.LAYOUT_TO_CLASS[d];return f?(b.state.set("placement",this.placement),this._adView=new f({model:b,sourceThreadUrl:this.sourceThreadUrl,redirectUrl:this.redirectUrl,publisherSettings:this.publisherSettings}),this.$el.html(this._adView.el),this._adView.render(),this._adView.isReady().then(a.bind(this._expand,this)),this._adView.isReady()):c.reject(new e.ValidationError('Specified ad layout "'+d+'" was not found.'))},getCurrentUnit:function(){return this._adView},disable:function(){this._enabled=!1,this._collapse()},enable:function(){this._enabled=!0,this._expand()},remove:function(){return this._unsetAd(),b.View.prototype.remove.apply(this,arguments)},_unsetAd:function(){this._adView&&(this._adView.model.state.unset("placement"),this._adView.remove(),this._adView=null)},_expand:function(){if(this._enabled&&(this.$el.css({height:"auto",visibility:"visible"}),this._adView)){this._adView.model.state.set("status",f.STATUS.DONE);var a=this._adView.model.getProvider();if("adsnativeServer"===a||"adsnativeVideoAdsServer"===a){var b=new g({src:d.discovery.criteoUrl||""});this.listenTo(b,"message",this._reportCriteo),b.render(),b.$el.css({height:0,visibility:"hidden"}),this._adView.$el.append(b.$el)}}},_reportCriteo:function(a){"criteo_demand"===a.eventName&&this._adView.model.reportCriteoDemand(a.hasAd)},_collapse:function(){this.$el.css({height:0,visibility:"hidden"})}});return o}),define("templates/discovery",["handlebars"],function(a){return a.template({1:function(a,b,c,d){var e,f='<div class="follow-btn-wrap">\n';return e=b["if"].call(a,null!=(e=null!=a?a.user:a)?e.isSession:e,{name:"if",hash:{},fn:this.program(2,d),inverse:this.program(5,d),data:d}),null!=e&&(f+=e),f+"</div>\n"},2:function(a,b,c,d){var e,f="";return e=b["if"].call(a,null!=(e=null!=a?a.user:a)?e.isEditable:e,{name:"if",hash:{},fn:this.program(3,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f+"\n"},3:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression;return'<a href="'+g(f(null!=(e=null!=a?a.user:a)?e.profileUrl:e,a))+'" data-action="edit-profile" target="_blank" class="btn follow-btn edit-profile">'+g(b.gettext.call(a,"Edit profile",{name:"gettext",hash:{},data:d}))+"</a>\n"},5:function(a,b,c,d){var e,f="";return e=b["if"].call(a,null!=(e=null!=a?a.user:a)?e.isPrivate:e,{name:"if",hash:{},fn:this.program(6,d),inverse:this.program(8,d),data:d}),null!=e&&(f+=e),f},6:function(a,b,c,d){var e=this.escapeExpression;return'<span class="btn follow-btn private">\n<i aria-hidden="true" class="icon-lock"></i>\n<span class="btn-text">'+e(b.gettext.call(a,"Private",{name:"gettext",hash:{},data:d}))+"</span>\n</span>\n"},8:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h='<a href="'+g(f(null!=(e=null!=a?a.user:a)?e.profileUrl:e,a))+'" class="btn follow-btn ';return e=b["if"].call(a,null!=(e=null!=a?a.user:a)?e.isFollowing:e,{name:"if",hash:{},fn:this.program(9,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+'" data-action="follow-user" data-user="'+g(f(null!=(e=null!=a?a.user:a)?e.id:e,a))+'">\n<span class="btn-text following-text">'+g(b.gettext.call(a,"Following",{name:"gettext",hash:{},data:d}))+'</span>\n<span class="btn-text follow-text">'+g(b.gettext.call(a,"Follow",{name:"gettext",hash:{},data:d}))+'</span>\n<i aria-hidden="true" class="icon-plus"></i> \n<i aria-hidden="true" class="icon-checkmark"></i>\n</a>\n'},9:function(a,b,c,d){return"following"},11:function(a,b,c,d,e){var f,g="";return f=b.each.call(a,null!=a?a.collection:a,{name:"each",hash:{},fn:this.program(12,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g},12:function(a,b,c,d,e){var f,g=this.lambda,h=this.escapeExpression,i='<li class="discovery-post';return f=b["if"].call(a,null!=e[1]?e[1].thumbnailsEnabled:e[1],{name:"if",hash:{},fn:this.program(13,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+=" post-"+h(g(d&&d.index,a))+'" id="discovery-link-'+h(g(null!=a?a.domIdSuffix:a,a))+'" data-id="'+h(g(null!=a?a.advertisement_id:a,a))+'">\n<a ',f=this.invokePartial(c.linkAttributes,"","linkAttributes",a,void 0,b,c,d),null!=f&&(i+=f),i+=' class="publisher-anchor-color">\n',f=b["if"].call(a,null!=e[1]?e[1].thumbnailsEnabled:e[1],{name:"if",hash:{},fn:this.program(15,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+='\n<header class="discovery-post-header">\n<h3 title="'+h(g(null!=a?a.title:a,a))+'">\n<span data-role="discovery-thread-title" class="title line-truncate" data-line-truncate="'+h(g(null!=(f=null!=e[1]?e[1].variant:e[1])?f.numLinesHeadline:f,a))+'">\n'+h(b.html.call(a,null!=a?a.title:a,{name:"html",hash:{},data:d}))+"\n</span>\n\n",f=b["if"].call(a,null!=(f=null!=e[1]?e[1].variant:e[1])?f.inlineMeta:f,{name:"if",hash:{},fn:this.program(17,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+="\n</h3>\n\n",f=b.unless.call(a,null!=(f=null!=e[1]?e[1].variant:e[1])?f.inlineMeta:f,{name:"unless",hash:{},fn:this.program(25,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+="</header>\n\n",f=b.if_all.call(a,null!=(f=null!=e[1]?e[1].variant:e[1])?f.contentPreviews:f,null!=a?a.preview:a,{name:"if_all",hash:{},fn:this.program(30,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+"</a>\n</li>\n"},13:function(a,b,c,d){return" hasthumbnail"},15:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<div class="thumbnail"\nstyle="background-image: url('+f(e(null!=a?a.thumbnailUrl:a,a))+');">\n</div>\n'},17:function(a,b,c,d){var e,f="";return e=b["if"].call(a,b.gt.call(a,null!=a?a.posts:a,0,{name:"gt",hash:{},data:d}),{name:"if",hash:{},fn:this.program(18,d),inverse:this.program(20,d),data:d}),null!=e&&(f+=e),e=b["if"].call(a,null!=a?a.brand:a,{name:"if",hash:{},fn:this.program(23,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f},18:function(a,b,c,d){var e,f='<span class="inline-meta">\n';return e=this.invokePartial(c.discoveryPostCount,"","discoveryPostCount",a,void 0,b,c,d),null!=e&&(f+=e),f+"</span>\n"},20:function(a,b,c,d){var e,f="";return e=b["if"].call(a,null!=a?a.createdAgo:a,{name:"if",hash:{},fn:this.program(21,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f},21:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<span class="inline-meta">'+f(e(null!=a?a.createdAgo:a,a))+"</span>\n"},23:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<span class="inline-meta">\n'+f(e(null!=a?a.brand:a,a))+"\n</span>\n"},25:function(a,b,c,d){var e,f='<ul class="meta">\n';return e=b["if"].call(a,b.gt.call(a,null!=a?a.posts:a,0,{name:"gt",hash:{},data:d}),{name:"if",hash:{},fn:this.program(26,d),inverse:this.noop,data:d}),null!=e&&(f+=e),e=b["if"].call(a,null!=a?a.createdAgo:a,{name:"if",hash:{},fn:this.program(28,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f+"</ul>\n"},26:function(a,b,c,d){var e,f='<li class="comments">\n';return e=this.invokePartial(c.discoveryPostCount,"","discoveryPostCount",a,void 0,b,c,d),null!=e&&(f+=e),f+"</li>\n"},28:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<li class="time">'+f(e(null!=a?a.createdAgo:a,a))+"</li>\n"},30:function(a,b,c,d){var e,f="";return e=this.invokePartial(c.discoveryContentPreview,"","discoveryContentPreview",a,void 0,b,c,d),null!=e&&(f+=e),f},32:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h='href="'+g(f(null!=a?a.redirectUrl:a,a))+'" ';return e=b["if"].call(a,null!=a?a.brand:a,{name:"if",hash:{},fn:this.program(33,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+"\n"},33:function(a,b,c,d){return'target="_blank" rel="nofollow norewrite"'},35:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h="<a ";return e=this.invokePartial(c.linkAttributes,"","linkAttributes",a,void 0,b,c,d),null!=e&&(h+=e),h+' class="top-comment" data-role="discovery-top-comment">\n<img data-src="'+g(f(null!=(e=null!=(e=null!=(e=null!=a?a.preview:a)?e.author:e)?e.avatar:e)?e.cache:e,a))+'" alt="'+g(b.gettext.call(a,"Avatar",{name:"gettext",hash:{},data:d}))+'" data-role="discovery-avatar">\n<p><span class="user" data-role="discovery-top-comment-author">'+g(f(null!=(e=null!=(e=null!=a?a.preview:a)?e.author:e)?e.name:e,a))+'</span> &#8212; <span data-role="discovery-top-comment-snippet" class="line-truncate" data-line-truncate="3">'+g(f(null!=(e=null!=a?a.preview:a)?e.plaintext:e,a))+"</span></p>\n</a>\n"},37:function(a,b,c,d){var e,f="";return e=b["if"].call(a,b.eq.call(a,null!=a?a.posts:a,1,{name:"eq",hash:{},data:d}),{name:"if",hash:{},fn:this.program(38,d),inverse:this.program(40,d),data:d}),null!=e&&(f+=e),f},38:function(a,b,c,d){var e=this.escapeExpression;return e(b.gettext.call(a,"1 comment",{name:"gettext",hash:{},data:d}))+"\n"},40:function(a,b,c,d){var e=this.escapeExpression;return e(b.gettext.call(a,"%(numPosts)s comments",{name:"gettext",hash:{numPosts:null!=a?a.posts:a},data:d}))+"\n"},42:function(a,b,c,d,e){var f,g=this.lambda,h=this.escapeExpression,i='<div id="'+h(g(null!=a?a.id:a,a))+'" class="discovery-main';return f=b["if"].call(a,null!=a?a.thumbnailsEnabled:a,{name:"if",hash:{},fn:this.program(43,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+='">\n<div id="discovery-note" class="discovery-note">\n',f=this.invokePartial(c.discoveryNote,"","discoveryNote",a,void 0,b,c,d),null!=f&&(i+=f),i+='</div>\n\n<div class="discovery-options">\n<button class="discovery-help" data-action="discovery-help">\n'+h(b.gettext.call(a,"What's this?",{name:"gettext",hash:{},data:d}))+"\n</button>\n</div>\n\n",f=b.each.call(a,null!=a?a.sections:a,{name:"each",hash:{},fn:this.program(45,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+"\n</div>\n"},43:function(a,b,c,d){return" discovery-thumbnails"},45:function(a,b,c,d,e){var f,g=this.lambda,h=this.escapeExpression,i='<section id="'+h(g(null!=a?a.id:a,a))+'" class="'+h(g(null!=a?a.className:a,a))+" discovery-col-"+h(g(d&&d.index,a))+" ";return f=b["if"].call(a,null!=a?a.showThumbnailsInRows:a,{name:"if",hash:{},fn:this.program(46,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+='" >\n<header class="discovery-col-header">\n\n',f=b["if"].call(a,b.eq.call(a,null!=a?a.type:a,"organic",{name:"eq",hash:{},data:d}),{name:"if",hash:{},fn:this.program(48,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+="\n",f=b["if"].call(a,b.eq.call(a,null!=a?a.type:a,"promoted",{name:"eq",hash:{},data:d}),{name:"if",hash:{},fn:this.program(50,d,e),inverse:this.noop,data:d}),null!=f&&(i+=f),i+'\n</header>\n<ul class="discovery-posts" data-role="discovery-posts">\n</ul>\n</section>\n'},46:function(a,b,c,d){return" thumbnails-rows"},48:function(a,b,c,d,e){var f=this.escapeExpression;return"<h2>"+f(b.gettext.call(a,"Also on %(forumName)s",{name:"gettext",hash:{forumName:b.getPartial.call(a,"forumName",null!=e[2]?e[2].forum:e[2],{name:"getPartial",hash:{},data:d})},data:d}))+"</h2>\n"},50:function(a,b,c,d){var e=this.escapeExpression;return"<h2>"+e(b.gettext.call(a,"Around The Web",{name:"gettext",hash:{},data:d}))+"</h2>\n"},52:function(a,b,c,d){var e=this.escapeExpression;return'<a href="https://help.disqus.com/customer/portal/articles/2069645-reveal-f-a-q-"\ntarget="_blank">'+e(b.gettext.call(a,"Learn more",{name:"gettext",hash:{},data:d}))+"</a>\n"},54:function(a,b,c,d){var e=this.escapeExpression;return'<a href="mailto:publisher-success@disqus.com" target="_blank">\n'+e(b.gettext.call(a,"give us feedback",{name:"gettext",hash:{},data:d}))+"</a>"},56:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return"<strong>"+f(e(null!=a?a.name:a,a))+"</strong>\n"},58:function(a,b,c,d){var e=this.escapeExpression;return'<div class="alert">\n<button class="close" data-action="discovery-help-close" title="'+e(b.gettext.call(a,"Close this box",{name:"gettext",hash:{},data:d}))+'">×</button>\n'+e(b.gettext.call(a,"Disqus helps you find new and interesting content, discussions and products. Some sponsors and ecommerce sites may pay us for these recommendations and links. %(learnMore)s or %(feedback)s.",{name:"gettext",hash:{feedback:b.getPartial.call(a,"feedback",{name:"getPartial",hash:{},data:d}),learnMore:b.getPartial.call(a,"learnMore",{name:"getPartial",hash:{},data:d})},data:d}))+"\n</div>\n"},60:function(a,b,c,d){var e,f=this.escapeExpression,g='<div class="generic-ad__block">\n<div class="icon__block text-subheading">\n<span class="icon-trophy icon"></span> '+f(b.gettext.call(a,"Sponsored",{name:"gettext",hash:{},data:d}))+'\n</div>\n<div data-role="iframe-wrapper" class="iframe-ad__wrapper">\n<iframe class="iframe-ad" frameborder="0" allowfullscreen overflow="hidden" scrolling="no" data-role="iframe-ad"></iframe>\n</div>\n<div class="sponsored">\n';return e=b.if_all.call(a,null!=a?a.targetUrl:a,null!=a?a.brandName:a,null!=a?a.summary:a,{name:"if_all",hash:{},fn:this.program(61,d),inverse:this.noop,data:d}),null!=e&&(g+=e),g+"</div>\n</div>\n"},61:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h='<div class="footer clickable-footer ';return e=b["if"].call(a,null!=a?a.brandImageUrl:a,{name:"if",hash:{},fn:this.program(62,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+='">\n',e=b["if"].call(a,null!=a?a.brandImageUrl:a,{name:"if",hash:{},fn:this.program(64,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+'<div class="brand-content">\n<a href="'+g(f(null!=a?a.targetUrl:a,a))+'" target="_blank" class="text-default">\n<small class="text-subheading">\n'+g(b.gettext.call(a,"Sponsored By %(name)s",{name:"gettext",hash:{name:b.tag.call(a,"strong",{name:"tag",hash:{text:null!=a?a.brandName:a},data:d})},data:d}))+'\n</small>\n<p class="brand-summary">\n'+g(f(null!=a?a.summary:a,a))+'\n</p>\n</a>\n</div>\n<div class="learn-more">\n<a href="'+g(f(null!=a?a.targetUrl:a,a))+'" target="_blank" class="learn-more-btn" data-role="learn-more">\n'+g(b.gettext.call(a,"Learn More",{name:"gettext",hash:{},data:d}))+' <i class="icon-arrow-forward"></i>\n</a>\n</div>\n</div>\n'},62:function(a,b,c,d){return"has-brand-logo"},64:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<div class="brand-logo avatar">\n<a href="'+f(e(null!=a?a.targetUrl:a,a))+'" target="_blank">\n<img src="'+f(e(null!=a?a.brandImageUrl:a,a))+'" />\n</a>\n</div>\n'},66:function(a,b,c,d){var e=this.escapeExpression,f=this.lambda;return'<div data-role="iab-ad" class="iab-ad">\n<div class="icon__block text-subheading">\n<span class="icon-trophy icon"></span> '+e(b.gettext.call(a,"Sponsored",{name:"gettext",hash:{},data:d}))+'\n</div>\n<iframe width="100%" frameborder="0" allowfullscreen overflow="hidden" name="'+e(f(null!=a?a.iframeName:a,a))+'" scrolling="no"></iframe>\n</div>\n'},68:function(a,b,c,d){var e,f=this.lambda,g=this.escapeExpression,h="";return e=b.if_all.call(a,null!=a?a.privacyClickUrl:a,null!=a?a.privacyImageUrl:a,{name:"if_all",hash:{},fn:this.program(69,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+'<a href="'+g(f(null!=a?a.targetUrl:a,a))+'" target="_blank" data-role="thumbnail-link"><img src="'+g(f(null!=a?a.thumbnailUrl:a,a))+'"></a>\n'},69:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<a class="ad-dr__thumb-privacy-link" href="'+f(e(null!=a?a.privacyClickUrl:a,a))+'" target="_blank"><img src="'+f(e(null!=a?a.privacyImageUrl:a,a))+'" alt="'+f(b.gettext.call(a,"Privacy",{name:"gettext",hash:{},data:d}))+'" /></a>\n'},71:function(a,b,c,d){var e,f=this.escapeExpression,g=this.lambda,h='<div class="ad-dr -thumb-right clearfix">\n<div class="ad-dr__thumb">\n';return e=this.invokePartial(c.adThumbnail,"","adThumbnail",a,void 0,b,c,d),null!=e&&(h+=e),h+='</div>\n<div class="ad-dr__content">\n<div class="ad-dr__company">\n',e=b["if"].call(a,null!=a?a.brandName:a,{name:"if",hash:{},fn:this.program(72,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+='<span class="icon-trophy" aria-hidden="true"></span><span>'+f(b.gettext.call(a,"Sponsored",{name:"gettext",hash:{},data:d}))+'</span>\n</div>\n<div class="ad-dr__thumb--mobile">\n',e=this.invokePartial(c.adThumbnail,"","adThumbnail",a,void 0,b,c,d),null!=e&&(h+=e),h+'</div>\n<h2 class="ad-dr__title">\n<a class="publisher-anchor-color" href="'+f(g(null!=a?a.targetUrl:a,a))+'" target="_blank">'+f(g(null!=a?a.title:a,a))+'</a>\n</h2>\n<div class="ad-dr__message">\n'+f(g(null!=a?a.summary:a,a))+'\n</div>\n<div class="ad-dr__cta">\n<a class="btn" href="'+f(g(null!=a?a.targetUrl:a,a))+'" target="_blank">'+f(b.gettext.call(a,"Learn More",{name:"gettext",hash:{},data:d}))+"</a>\n</div>\n</div>\n</div>\n"},72:function(a,b,c,d){var e=this.lambda,f=this.escapeExpression;return'<a class="publisher-anchor-color" href="'+f(e(null!=a?a.targetUrl:a,a))+'" target="_blank">\n'+f(e(null!=a?a.brandName:a,a))+'\n</a><span class="bullet" aria-hidden="true">•</span>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d,e){var f,g="";return f=b.partial.call(a,"followButton",{name:"partial",hash:{},fn:this.program(1,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"discoveryCollection",{name:"partial",hash:{},fn:this.program(11,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"linkAttributes",{name:"partial",hash:{},fn:this.program(32,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"discoveryContentPreview",{name:"partial",hash:{},fn:this.program(35,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"discoveryPostCount",{name:"partial",hash:{},fn:this.program(37,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"discoveryMain",{name:"partial",hash:{},fn:this.program(42,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"learnMore",{name:"partial",hash:{},fn:this.program(52,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"feedback",{name:"partial",hash:{},fn:this.program(54,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n\n",f=b.partial.call(a,"forumName",{name:"partial",hash:{},fn:this.program(56,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n\n",f=b.partial.call(a,"discoveryNote",{name:"partial",hash:{},fn:this.program(58,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"videoAd",{name:"partial",hash:{},fn:this.program(60,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"iabAd",{name:"partial",hash:{},fn:this.program(66,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"adThumbnail",{name:"partial",hash:{},fn:this.program(68,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g+="\n",f=b.partial.call(a,"imageAd",{name:"partial",hash:{},fn:this.program(71,d,e),inverse:this.noop,data:d}),null!=f&&(g+=f),g},usePartial:!0,useData:!0,useDepths:!0})}),define("discovery/main",["backbone","underscore","jquery","loglevel","when","core/analytics/identity","core/analytics/jester","core/utils/storage","common/urls","common/Session","discovery/collections","discovery/helpers","discovery/variants","discovery/exceptions","discovery/views/Placement","discovery/models/SponsoredLinkAd","discovery/models/State","templates/discovery"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){"use strict";r();var s={},t=1e4;return s.DiscoveryApp=a.Model.extend({defaults:{name:"promoted",inlineMeta:!0,contentPreviews:!1,organicEnabled:!0,promotedEnabled:!0,topPlacementEnabled:!1,redirectUrl:"http://disq.us/url",sourceThread:null,sourceForum:null,sourceThreadUrl:null,discoverySettingsUrl:null,numColumns:2,maxPerColumn:null,maxOrganicTextLinks:null,maxPromotedTextLinks:null,maxPromotedThumbnailLinks:null,maxPromotedThumbnailLinksMobile:null,innerContainerName:"discovery-main",promotedSide:"right",hasHighlightedPost:!0,lineTruncationEnabled:!0,numLinesHeadline:2,requestBinOverride:null,js:null,css:null,seenByUserThresholdTime:2e3,trackAdVisibility:null,pageUrl:null,pageReferrer:null},initialize:function(a){var b=this;b.session=j.get(),b.triedAds={},b.topPlacement=new o({placement:"top",sourceThreadUrl:this.get("sourceThreadUrl"),redirectUrl:this.get("redirectUrl"),publisherSettings:b.getPublisherSettings()}),c("#placement-top").html(b.topPlacement.$el),b.listenTo(b,"change:hasHighlightedPost",function(a,c){c?b.topPlacement.disable():b.topPlacement.enable()}),b.bottomPlacement=new o({placement:"bottom",redirectUrl:this.get("redirectUrl"),publisherSettings:b.getPublisherSettings()}),c("#placement-bottom").html(b.bottomPlacement.$el),b.configure(a),b.createDataCollections()},getPublisherSettings:function(){return b.pick(this.attributes,"colorScheme","typeface","safeAnchorColor")},createDataCollections:function(){this.ads=new k.AdvertisementCollection;var a="Organic";this.threads=new k.RelatedThreadCollection([],{name:a,minLength:this.get("promotedEnabled")?1:2,maxLength:this.getCollectionMax(a)})},configure:function(a){a=a||{};var c=this,d=m[c.get("name")]||{};if(c.get("thumbnailsEnabled")&&b.extend(d,m.thumbnails),c.set(b.defaults(a,d)),c.has("maxPerColumn")){var e=c.get("promotedEnabled")?1:2;c.set("maxOrganicTextLinks",e*c.get("maxPerColumn")),c.set("maxPromotedTextLinks",c.get("maxPerColumn"))}else c.has("maxOrganicTextLinks")&&c.set("maxPerColumn",c.get("maxOrganicTextLinks"));c.set("innerContainerId",c.get("innerContainerName")+"-"+c.cid)},getViewportWidth:function(){return c(document).width()},getThumbnailLinksMobile:function(a){return this.getViewportWidth()<=480&&this.get("max"+a+"ThumbnailLinksMobile")},getCollectionMax:function(a){
return this.getThumbnailLinksMobile(a)||this.get("max"+a+"ThumbnailLinks")||this.get("max"+a+"TextLinks")},run:function(){var a=this,b=e(a.get("organicEnabled")&&a.getDataOrganic());return a.get("promotedEnabled")||a.get("adsVideoEnabled")||a.get("adsDRNativeEnabled")?(d.debug("Ads enabled, making request to listPromoted"),a.getDataPromoted().then(function(){return b.always(function(){return a.runAdDaisyChain()})}).otherwise(function(){return d.debug("Ad daisy chain failed, falling back to organic only links"),b.then(function(){return a.renderOrganicLinks()})}).otherwise(function(a){d.debug("Organic-only fallback failed, too"),l.reportError(a)})):(d.debug("Ads disabled, starting organic-only Discovery"),b.then(function(){return a.threads.length?a.renderOrganicLinks():void d.debug("No organic links, bailing out")}).otherwise(function(a){d.debug("Organic-only Discovery failed"),l.reportError(a)}))},renderOrganicLinks:function(){var a=new p({layout:"links"},{sponsoredLinks:new k.SponsoredLinksCollection([],{maxLength:this.getCollectionMax("Promoted")}),threads:this.threads,app:this});this.bottomPlacement.tryAd(a)},runAdDaisyChain:function(){function a(a,b){try{return d.chainAds(a,b,0)}catch(c){return l.reportError(c),e.reject(c)}}var c,d=this,f=d.ads.getTopAds(),g=d.ads.getBottomAds(),h=a(d.topPlacement,f),i=b.partial(a,d.bottomPlacement,g);return c=d.get("topPlacementEnabled")?h.always(i):i(),e.any([h,c])},getAllowedTopUnits:function(){var a=[];return this.get("hasHighlightedPost")||(this.get("adsVideoEnabled")&&a.push("video"),this.get("adsDRNativeEnabled")&&a.push("native_dr")),this.get("topPlacementEnabled")&&a.push("sponsored_links"),a},getAllowedBottomUnits:function(){return this.get("promotedEnabled")?["sponsored_links"]:[]},getDataOrganic:function(){var a={timeout:t,data:{thread:this.get("sourceThread").id},reset:!0,humanFriendlyTimestamp:!0};return this.threads.fetch(a,this.get("contentPreviews"))},getDataPromoted:function(){var a=this;a.get("preview")&&a.has("previewQueryParam")&&(a.ads.url=i.tempest+"/preview/serve/"+a.get("previewQueryParam"));var c={timeout:t,data:{imp:f.impression.impId,doc_width:this.getViewportWidth(),is_logged_out:this.session.isKnownToBeLoggedOut(),has_flash:l.hasFlash(),has_highlighted_post:this.get("hasHighlightedPost"),page_url:this.get("pageUrl"),page_referrer:this.get("pageReferrer"),forum:this.get("sourceForum").id,forum_id:this.get("sourceForum").pk,thread_id:this.get("sourceThread").id,top_placement:this.getAllowedTopUnits(),bottom_placement:this.getAllowedBottomUnits(),color_scheme:this.get("colorScheme"),anchor_color:this.get("safeAnchorColor"),typeface:this.get("typeface"),canonical_url:this.get("canonicalUrl"),experiment:this.get("experiment"),variant:this.get("variant"),service:this.get("service")},omitDisqusApiKey:!0,reset:!0,sponsoredLinksMaxLength:this.getCollectionMax("Promoted"),threads:this.threads,app:this},j=window.navigator&&/Apple/.test(window.navigator.vendor)&&/Safari/.test(window.navigator.userAgent);window.XMLHttpRequest&&"withCredentials"in new window.XMLHttpRequest&&!j?(c.dataType="json",c.xhrFields=b.defaults({withCredentials:!0},c.xhrFields),c.headers={}):c.dataType="jsonp";var k=h.get("lp:headers");return b.isEmpty(k)||(c.data.HTTP_X_DEBUG=1,b.each(k,function(a){c.data["HTTP_X_"+a.name]=a.value})),a.has("gutterSwitch")&&(c.data.HTTP_X_DEBUG=1,c.data["HTTP_X_GUTTER_"+a.get("gutterSwitch").replace(":","__")]=1),null!==a.get("requestBinOverride")&&(c.data.HTTP_X_DEBUG=1,c.data.HTTP_X_DEBUG_BIN=a.get("requestBinOverride")),this.ads.fetch(c).then(function(b){d.debug("Response from listPromoted:",b);var c=b.bin;if(!c)throw new n.NoBinError("No bin specified");a.set("requestBin",c),a.topPlacement.setRequestBin(a.get("requestBin")),a.bottomPlacement.setRequestBin(a.get("requestBin"))},function(a){return l.requestWasAdBlocked(a,c)?(g.client.emit({verb:"block",object_type:"advertisement",ad_product_name:"sponsored_links",object_id:190343,advertisement_id:190343}),e.reject(new n.AdBlockError("Ad block enabled"))):void 0})},chainAds:function(a,b,c){var f=this;if(c>=b.length)return e.defer().reject(new n.AdsExhaustedError("No more ads available."));var g=b.at(c);return d.debug(g.toLogString()+": Processing ad "+(c+1)+" ad out of "+b.length+" ads"),f.triedAds[g.id]||g.state.isDone()?(d.debug("Ad has already been tried, skipping"),f.chainAds(a,b,c+1)):g.fetch({sourceThreadUrl:f.get("sourceThreadUrl")}).then(function(){var b=a.tryAd(g);return b.always(function(){g.id&&(f.triedAds[g.id]=!0),g.state.set("status",q.STATUS.DONE)}),b}).otherwise(function(d){return l.reportError(d,g),f.chainAds(a,b,c+1)})}}),s.init=function(a,c,d,e){var f=a.forum.get("settings"),g=l.generateVariantConfig(f,d);if(g){var h=b.extend({},g,{sourceThread:a.toJSON(),sourceForum:a.forum.toJSON(),sourceThreadUrl:a.currentUrl||document.referrer,discoverySettingsUrl:f.discoverySettingsUrl,adsDRNativeEnabled:f.adsDRNativeEnabled,adsVideoEnabled:f.adsVideoEnabled,organicEnabled:f.organicDiscoveryEnabled,topPlacementEnabled:g.topPlacementEnabled&&!e.hasHighlightedPost,hasHighlightedPost:e.hasHighlightedPost,pageUrl:e.pageUrl,canonicalUrl:e.canonicalUrl,pageReferrer:e.pageReferrer,colorScheme:e.colorScheme,typeface:e.typeface,safeAnchorColor:e.safeAnchorColor,service:e.service,experiment:e.experiment,variant:e.variant});if(d.preview){var i=document.createElement("a");i.href=h.sourceThreadUrl,h.previewQueryParam=i.search,h.preview=!0}var j=c.get("discoveryRequestBin");j&&(h.requestBinOverride=j),c.get("gutterSwitch")&&(h.gutterSwitch=c.get("gutterSwitch"));var k=new s.DiscoveryApp(h);return k.run(),k}},s}),define("discovery.bundle",function(){});